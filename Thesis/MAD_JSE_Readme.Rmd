---
title: "Untitled"
output: github_document
---
# SA divi analysis 
- show performance and risk statistcis and modify by stratification. 
- constituent analysis. 
- then fit show the trends in alpha, to clearly show that it is a weak proxy to value, over and above cumulative return. This is the ROI. When doe s the ROI fade, and in which portfolio.
- we then verify the results to confirm this. 
```{r}
#  lets get the cumulative returns 

Loc <- "J433_J406/Divi/"
Loc_2 <- "J433_J406/Divi/Capped_SWIX/"
source("/Users/gabrielrambanapasi/Desktop/Much Ado Dividends/Much-Ado-Dividends/Thesis/write up/code/Get_dat_1.R")
source("/Users/gabrielrambanapasi/Desktop/Much Ado Dividends/Much-Ado-Dividends/Thesis/write up/code/EOM.R")

library(glue)
library(tidyverse)
df1 <- Get_dat(Loc, Loc_2,Port = "Divi1","Returns")
df2 <- Get_dat(Loc, Loc_2,Port = "Divi2","Returns")
df3 <- Get_dat(Loc, Loc_2,Port = "Divi3","Returns")
df4 <- Get_dat(Loc, Loc_2,Port = "Divi4","Returns")
dfbm <- Get_dat(Loc, Loc_2,Port = "Divi1","Returns_BM")
df <- bind_rows(df1, df2, df3, df4, dfbm %>% rename(Returns = BM_Returns) %>% mutate(Portfolio = "BM")) %>% select(date, Portfolio, Returns) %>% ungroup() %>% select(-YM)

# get the cumulative returns 

df %>% group_by(Portfolio) %>%  mutate(ROI = cumprod(1+Returns), ROI = ROI/first(ROI)) %>% ggplot + geom_line(aes(date, ROI, color = Portfolio))


```

We consider periods as high / low volatility when the realized volatility of the J200 was below
(above) its lowest (highest) quintile for at least 50 trading days. 
```{r}
# stratify returns by Vol 

df_volatility <- bind_rows (df %>%  filter(date %in% hivol_per_vector_sa) %>% mutate(roi = cumprod(1+Returns)) %>% group_by(Portfolio) %>%  summarise(Months = n(),ROI = last(roi),  Ann.roi = ROI^12/Months -1, SD = sd(ROI)) %>% mutate(MarketCycle = "High Volatility ") %>% select(-Months),

df %>%  filter(date %in% lovol_per_vector_sa) %>% mutate(roi = cumprod(1+Returns)) %>% group_by(Portfolio) %>%  summarise(Months = n(), ROI = last(roi),  Ann.roi = last(ROI)^12/Months -1, SD = sd(ROIi)) %>% mutate(MarketCycle = "Low Volatility ") %>% select(-Months))

df_volatility
# maybe look into binding columns in this period with avg drawdowns to give a more direct measure of risk


```


```{r}
#  by interest rate regime 

df_interest <- bind_rows(df %>%  filter(date %in% Hiking_date_vector_sa) %>% mutate(roi = cumprod(1+Returns)) %>% group_by(Portfolio) %>%  summarise(Months = n(), ROI  = last(ROI),  Ann.roi = last(ROI)^4/Months -1, SD = sd(ROI)) %>% mutate(MarketCycle = "Hiking "),

df %>%  filter(date %in% Neutral_date_vector_sa) %>% mutate(roi = cumprod(1+Returns)) %>% group_by(Portfolio) %>%  summarise(Months = n(), ROI  = last(ROI),  Ann.roi = last(ROI)^4/Months -1, SD = sd(ROI)) %>% mutate(MarketCycle = "Nuetral"),  

df %>%  filter(date %in% Cutting_date_vector_sa) %>% mutate(roi = cumprod(1+Returns)) %>% group_by(Portfolio) %>%  summarise(Months = n(), ROI = last(ROI),  Ann.roi = ROI^4/Months -1,SD = sd(ROI)) %>% mutate(MarketCycle = "Cutting") ) %>% filter(Months >1) %>% arrange(desc("Total ROI %")) %>% select(-Months)

df_interest

```

change the names of the portfolio so that its easier to read.

# constiuent analysis

- we dont have consituent data for all the indcies for the entirity of the sample period
- 

```{r}
# lets see the holdings comparison 
df1_h <- Get_dat(Loc, Loc_2,Port = "Divi1","Holds") %>% mutate(Portfolio = "Divi1")
df2_h <- Get_dat(Loc, Loc_2,Port = "Divi2","Holds")%>% mutate(Portfolio = "Divi2")
df3_h <- Get_dat(Loc, Loc_2,Port = "Divi3","Holds")%>% mutate(Portfolio = "Divi3")
df4_h <- Get_dat(Loc, Loc_2,Port = "Divi4","Holds")%>% mutate(Portfolio = "Divi4")
dfh <- bind_rows(df1_h, df2_h, df3_h, df4_h) %>% ungroup() %>% select(-YM)

loc_bm <- list.files("J433_J406/Divi/Capped_SWIX/", pattern = "\\.rds$", full.names = TRUE)

dfh_bm <- loc_bm[grepl("Holdings.rds", loc_bm)] %>% read_rds(.) %>% select(date, Tickers, Name, BM_Weight = Weight, Sector ) %>% mutate(Sector = gsub("N/A", NA, Sector))  %>% Make_calendar_EOM(.)%>% arrange(date) %>%  ungroup()

a <- loc_bm[grepl("Holdings.rds", loc_bm)] %>% read_rds(.) %>% select(date, Tickers, Name, ESG, DY, ends_with(" Exp")  )  %>% Make_calendar_EOM(.)%>% arrange(date) %>% ungroup() %>% select(-YM)


dfh_bm <- dfh_bm  %>%
  mutate(Month = format(date, "%b"),Year = format(date, "%Y")) %>% 
  group_by(Year, Name) %>% 
  filter(Month %in% c("Oct")) %>% ungroup() %>% select(-Year , -Month) %>% merge(., sectors_to_merge
  )
  
# selecting last quarter rebalancing

dfh <- dfh  %>%
  mutate(Month = format(date, "%b"),Year = format(date, "%Y")) %>% 
  group_by(Year, Name, Portfolio) %>% 
  filter(Month %in% c("Oct"))%>% ungroup() %>% select( -Month, -Year) %>% 
  # now get sector weighting 
  merge(., sectors_to_merge
  )

# get the deviations
dates_to_filter <- full_join(dfh, dfh_bm, by = c("date", "Name", "Tickers")) %>% select(-YM) %>% mutate(excess_wts = Weight - BM_Weight) %>% filter(!is.na(Weight)) %>% select(date) %>% arrange(date) %>% pull() %>% unique()

# I am looking into return attribution more than risk attribution, so lets analyze the impact of the active decisions from the divi portfolios. Maybe bring in some aspects of micro attribution, ones that are consistent with style.

# accucracy is imparove in short time intervals, most appropriate for little turnover
```

# Actual Analysis 
- I am looking into return attribution, so lets analyze the impact of the active decisions from the divi portfolios. Maybe bring in some aspects of micro attribution, ones that are consistent with style.

- Brinson-Hood-Beebowe(BHB) and Brinson-Fachler, attribute equity in a unique way, take "excess weights" return on the benchmark and benchmark weights and interaction the excesses of both.

- There go about the following equations
$$
BHB  =(P_W-B_W) \times r_B
$$

$$
BF =(P_W-B_W)\left(r_B-R_B\right).
$$

- so we look at return from a relative to benchmark perspective BF, BHB looks at it in absolute terms. 
- so where is it gaining and which sectors are responsible, in terms of times it did that, which time frame. we get that from the absolute returns. 
- pick out moments of positive and negative returns from BF and analyse

```{r}
# from our excess returns calc , this data just has divi excess returns, join by date
Excess_returs_divi <- df %>% 
  filter(date %in% dates_to_filter) %>% 
  spread(Portfolio, Returns) %>%
  mutate_at(3:6, ~ (.)- BM ) %>% select(-BM) %>% ungroup() %>% 
  gather(index, ex_ret, -date)

#  excess weights 

Excess_weights <-  full_join(dfh_bm, dfh, by = c("date", "Name", "Tickers"))  %>%
  arrange(date) %>% 
filter(date %in% dates_to_filter) %>% 
filter(!is.na(Portfolio)) %>% 
group_by(Portfolio, date) %>%
summarize(Index_Weight =Weight/sum(Weight), BM_Weight = BM_Weight/sum(BM_Weight)) %>%
mutate(ExcessWeight = (Index_Weight - BM_Weight)) %>% 
  summarize( ExcessWeight= mean(ExcessWeight)) %>% spread(Portfolio, ExcessWeight) %>%
  gather(index, ex_weight, -date)

# combine to get the BR DF 
BF_df <- left_join(Excess_weights, Excess_returs_divi, c("date", "index")) %>% filter(!is.na(ex_weight)) %>%  mutate(BR = ex_weight * ex_ret) %>% select(date, BR, index)

#  there are momnets in which we dont have the ex_weight for all portfolios in 2008, just going to excleude them from the anal;ysis

Source("write up/code/Theme.R")

g <- BF_df %>% 
  ggplot(aes(date, BR)) + 
  geom_line() + 
  facet_grid(~index) +
  gabriel_theme + 
  labs(title = "Relative Return Performance", x = NULL)
g 
# get the hit range of the strategy throughout time 
Hit_df <- left_join(Excess_weights, Excess_returs_divi, by = c("date", "index")) %>%
  filter(!is.na(ex_weight)) %>%
  mutate(BR = ex_weight * ex_ret) %>%
  select(date, BR, index) %>%
  group_by(index) %>%
  mutate(Positive = sum(BR > 0), Tot = n()) %>% summarize(`Hit Rate` = mean(Positive/Tot ))
                            
```

















