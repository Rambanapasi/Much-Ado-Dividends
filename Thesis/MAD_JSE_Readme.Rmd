---
title: "Untitled"
output: github_document
---
# SA divi analysis 
- show performance and risk statistcis and modify by stratification. 
- constituent analysis. 
- then fit show the trends in alpha, to clearly show that it is a weak proxy to value, over and above cumulative return. This is the ROI. When doe s the ROI fade, and in which portfolio.
- we then verify the results to confirm this. 
```{r}
#  lets get the cumulative returns 

Loc <- "Desktop/Much Ado Dividends/Much-Ado-Dividends/Thesis/write up/J433_J406/Divi/"
Loc_2 <- "Desktop/Much Ado Dividends/Much-Ado-Dividends/Thesis/write up/J433_J406/Capped_SWIX/"

source("/Users/gabrielrambanapasi/Desktop/Much Ado Dividends/Much-Ado-Dividends/Thesis/write up/code/Get_dat_1.R")
source("/Users/gabrielrambanapasi/Desktop/Much Ado Dividends/Much-Ado-Dividends/Thesis/write up/code/EOM.R")


df1 <- Get_dat(Loc, Loc_2,Port = "Divi1","Returns")
df2 <- Get_dat(Loc, Loc_2,Port = "Divi2","Returns")
df3 <- Get_dat(Loc, Loc_2,Port = "Divi3","Returns")
df4 <- Get_dat(Loc, Loc_2,Port = "Divi4","Returns")
dfbm <- Get_dat(Loc, Loc_2,Port = "Divi1","Returns_BM")
df <- bind_rows(df1, df2, df3, df4, dfbm %>% rename(Returns = BM_Returns) %>% mutate(Portfolio = "BM")) %>% select(date, Portfolio, Returns) %>% ungroup() %>% select(-YM)

# get the cumulative returns 

df %>% group_by(Portfolio) %>%  mutate(ROI = cumprod(1+Returns), ROI = ROI/first(ROI)) %>% ggplot + geom_line(aes(date, ROI, color = Portfolio))


```
# ML Estimation 

- trying to model when this data will reach an inflection point and what percentage of the time. 
- assume that the data follows a possion distribution, its exponential

```{r}
set.seed(200)
idx <- createDataPartition(Y$Count, p=0.25,list=FALSE)

#Negative log likelihood Function using Poisson Distribution
nll <- function(theta0,theta1) {
  
  x <- Y$age[-idx]
  y <- Y$Count[-idx]
  
  mu = exp(theta0 + x*theta1)
  
  -sum(y*(log(mu)) - mu)
}

#Parameter Estimation
est <- stats4::mle(minuslog=nll, start=list(theta0=2,theta1=0))
summary(est)

#Prediction on test set and RMSE
pred.ts <- (exp(coef(est)['theta0'] + Y$age[idx]*coef(est)['theta1'] ))
rmse(pred.ts, Y$Count[idx])
#86.95227
```


```{r}
# stratify returns by Vol 

df %>%  filter(date %in% lovol_per_vector_sa) %>% mutate(roi = cumprod(1+Returns)) %>% group_by(Portfolio) %>%  summarise(Months = n(), Total.Roi = last(roi),  Ann.roi = last(roi)^Months/12 -1, median.roi = median(roi)) %>% mutate(MarketCycle = "High Vol ") %>% select(-Months)

df %>%  filter(date %in% lovol_per_vector_sa) %>% mutate(roi = cumprod(1+Returns)) %>% group_by(Portfolio) %>%  summarise(Months = n(), Total.Roi = last(roi),  Ann.roi = last(roi)^Months/12 -1, median.roi = median(roi)) %>% mutate(MarketCycle = "High Vol ") %>% select(-Months)
```


```{r}
#  by interest rate regime 

df %>%  filter(date %in% Hiking_date_vector_sa) %>% mutate(roi = cumprod(1+Returns)) %>% group_by(Portfolio) %>%  summarise(Months = n(), Total.Roi = last(roi),  Ann.roi = last(roi)^Months/4 -1, median.roi = median(roi)) %>% mutate(MarketCycle = "High Vol ") 

df %>%  filter(date %in% Neutral_date_vector_sa) %>% mutate(roi = cumprod(1+Returns)) %>% group_by(Portfolio) %>%  summarise(Months = n(), Total.Roi = last(roi),  Ann.roi = last(roi)^Months/4 -1, median.roi = median(roi)) %>% mutate(MarketCycle = "High Vol ") 

df %>%  filter(date %in% Cutting_date_vector_sa) %>% mutate(roi = cumprod(1+Returns)) %>% group_by(Portfolio) %>%  summarise(Months = n(), Total.Roi = last(roi),  Ann.roi = last(roi)^Months/4 -1, median.roi = median(roi)) %>% mutate(MarketCycle = "High Vol ") 

```

```{r}


```

