ifelse(RollSD <= botQ, "LowVol", "Normal_Vol")))
# US strat
hivol_per_vector_us <- strat_df %>% filter(Strat %in% "HiVol") %>% pull(Date)
lovol_per_vector_us <- strat_df %>% filter(Strat %in% "LowVol") %>% pull(Date)
# Europe strat
Vixroll <- Rolling_sd(V2X ,"V2X")
# get the top quartile and bottom quartil
strat_df <- Vixroll %>% mutate(topQ = quantile(RollSD, probs = 0.8),
botQ = quantile(RollSD, probs = 0.2),
Strat = ifelse(RollSD >= topQ, "HiVol",
ifelse(RollSD <= botQ, "LowVol", "Normal_Vol")))
hivol_per_vector_eu  <- strat_df %>% filter(Strat %in% "HiVol") %>% pull(Date)
lovol_per_vector_eu  <- strat_df %>% filter(Strat %in% "LowVol") %>% pull(Date)
# SA
Vixroll <- Rolling_sd(JSV ,"JALSHVOL")
# get the top quartile and bottom quartil
strat_df <- Vixroll %>% mutate(topQ = quantile(RollSD, probs = 0.8),
botQ = quantile(RollSD, probs = 0.2),
Strat = ifelse(RollSD >= topQ, "HiVol",
ifelse(RollSD <= botQ, "LowVol", "Normal_Vol")))
hivol_per_vector_sa <- strat_df %>% filter(Strat %in% "HiVol") %>% pull(Date)
lovol_per_vector_sa <- strat_df %>% filter(Strat %in% "LowVol") %>% pull(Date)
# get entire returns and apply the vector above
# ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# get all permutatation
A <- df %>% simple_excess_return(.,"FUDP", "TUKXG")
B <- df %>% simple_excess_return(., "M2EFDY", "GDUEEGF")
C <- df %>% simple_excess_return(., "M2EUGDY", "GDDUE15X")
D <- df %>% simple_excess_return(., "M2GBDY", "GDDUUK")
E <- df %>% simple_excess_return(., "M2JPDY", "TJDIVD")
F1 <- df %>% simple_excess_return(., "M2USADVD", "GDDUUS")
G <- df %>% simple_excess_return(., "M2WDHDVD", "GDDUWI")
H <- df %>% simple_excess_return(., "SPDAEET", "SPTR350E")
I <- df %>% simple_excess_return(., "SPDAUDT", "SPXT")
J <- df %>% simple_excess_return(., "SPJXDAJT", "TPXDDVD")
K <- df %>% simple_excess_return(., "SPSADAZT", "JALSH")
L <- df %>% simple_excess_return(., "TJDIVD", "JALSH")
#  US excess return
excessreturns_us <- list( F1, I ,J) %>%
reduce(inner_join, by='date') %>% gather(ticker, excess, -date)
# EU  excess return
excessreturns_eu <- list(A, C, D, H) %>%
reduce(inner_join, by='date') %>% gather(ticker, excess, -date)
#  SA excess returns in a single data frame
excessreturns_em <- list(B, K, L) %>%
reduce(inner_join, by='date') %>% gather(ticker, excess, -date)
# US stat df
hivol <- excessreturns %>%
filter(date %in% hivol_per_vector) %>%
filter(date >= fmxdat::safe_month_min(last(date), N = 36)) %>%
group_by(ticker) %>%
summarise(Hivol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
hivol <- excessreturns_us %>%
filter(Date %in% hivol_per_vector) %>%
filter(Date >= fmxdat::safe_month_min(last(Date), N = 36)) %>%
group_by(ticker) %>%
summarise(Hivol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
hivol <- excessreturns_us %>%
filter(Date %in% hivol_per_vector_us) %>%
filter(Date >= fmxdat::safe_month_min(last(Date), N = 36)) %>%
group_by(ticker) %>%
summarise(Hivol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
excessreturns_em
excessreturns_us %>%
filter(Date %in% hivol_per_vector_us) %>%
filter(Date >= fmxdat::safe_month_min(last(Date), N = 36)) %>%
group_by(ticker) %>%
summarise(Hivol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
excessreturns_em
excessreturns_us %>%
filter(date %in% hivol_per_vector_us) %>%
filter(date >= fmxdat::safe_month_min(last(date), N = 36)) %>%
group_by(ticker) %>%
summarise(Hivol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
hivol
hivol <- excessreturns_us %>%
filter(date %in% hivol_per_vector_us) %>%
filter(date >= fmxdat::safe_month_min(last(date), N = 36)) %>%
group_by(ticker) %>%
summarise(Hivol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
hivol
hivol
Usvolcom <- left_join(hivol, lovol, by = ticker)
lovol <-  excessreturns_us %>%
filter(date %in% lovol_per_vector_us) %>%
filter(date >= fmxdat::safe_month_min(last(date), N = 36)) %>%
group_by(ticker) %>%
summarise(lovol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
Usvolcom <- left_join(hivol, lovol, by = ticker)
lovol
hivol <- excessreturns_us %>%
filter(date %in% hivol_per_vector_us) %>%
filter(date >= fmxdat::safe_month_min(last(date), N = 36)) %>%
group_by(ticker) %>%
summarise(Hivol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
lovol <-  excessreturns_us %>%
filter(date %in% lovol_per_vector_us) %>%
filter(date >= fmxdat::safe_month_min(last(date), N = 36)) %>%
group_by(ticker) %>%
summarise(lovol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
Usvolcom <- left_join(hivol, lovol, by = "ticker")
# EU strat df
hivol <- excessreturns_eu %>%
filter(date %in% hivol_per_vector_eu) %>%
filter(date >= fmxdat::safe_month_min(last(date), N = 36)) %>%
group_by(ticker) %>%
summarise(Hivol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
lovol <-  excessreturns_eu %>%
filter(date %in% lovol_per_vector_eu) %>%
filter(date >= fmxdat::safe_month_min(last(date), N = 36)) %>%
group_by(ticker) %>%
summarise(lovol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
euvolcom <- left_join(hivol, lovol, by = "ticker")
# EM strat df
hivol <- excessreturns_em %>%
filter(date %in% hivol_per_vector_sa) %>%
filter(date >= fmxdat::safe_month_min(last(date), N = 36)) %>%
group_by(ticker) %>%
summarise(Hivol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
lovol <-  excessreturns_em %>%
filter(date %in% lovol_per_vector_sa) %>%
filter(date >= fmxdat::safe_month_min(last(date), N = 36)) %>%
group_by(ticker) %>%
summarise(lovol_return = prod(1+excess, na.rm=T) ^ (12/(36)) -1 )
emvolcom <- left_join(hivol, lovol, by = "ticker")
euvolcom
emvolcom
bind_rows(Usvolcom, euvolcom, emvolcom)
divi_vol_df <- bind_rows(Usvolcom, euvolcom, emvolcom)
divi_vol_df %>%
mutate(trend = case_when(
Hivol_return > lovol_return ~ "higher",
TRUE ~ "lower"
))
divi_vol_df  <- divi_vol_df %>%
mutate(Volatility_Protection = case_when(
Hivol_return > lovol_return ~ "higher",
TRUE ~ "lower"
))
divi_vol_df
divi_vol_df  <- divi_vol_df %>%
mutate(Volatility_Protection = case_when(
Hivol_return > lovol_return ~ "gives more protection in high volatility periods",
TRUE ~ "gives lower protection in high volatility periods"
))
kable( volreturns)
Table_data <- readxl::read_xlsx("data/Instruments from MAD.xlsx")
library(knitr)
kable(Table_data)
kable(divi_vol_df)
divi_vol_df  <- divi_vol_df %>%
mutate(Volatility_Protection = case_when(
Hivol_return > lovol_return ~ "high protection",
TRUE ~ "low protection"
))
kable(divi_vol_df)
divi_vol_df %>%
mutate(Volatility_Protection = case_when(
Hivol_return > lovol_return ~ "high protection",
TRUE ~ "low protection"
))
interest <- readxl::read_xlsx("data/Interest Rates.xlsx")
interest
mutate(Volatility_Protection = case_when(
+     Hivol_return > lovol_return ~ "high protection",
+     TRUE ~ "low protection"
+   )))
mutate(Volatility_Protection = case_when(
+     Hivol_return > lovol_return ~ "high protection",
+     TRUE ~ "low protection"
+   ))
kable(divi_vol_df)
mutate(Volatility_Protection = case_when(
+     Hivol_return > lovol_return ~ "high",
+     TRUE ~ "low"
+   )))
mutate(Volatility_Protection = case_when(
Hivol_return > lovol_return ~ "high protection",
TRUE ~ "low protection"
))
mutate(Volatility_Protection = case_when(
hivol_return > lovol_return ~ "high protection",
TRUE ~ "low protection"
))
divi_vol_df
mutate(Volatility_Protection = case_when(
Hivol_return > lovol_return ~ "high protection",
TRUE ~ "low protection"
))
pacman::p_load(RiskPortfolios)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 5, fig.pos="H", fig.pos = 'H')
# Note: Include = FALSE implies the code is executed, but not printed in your pdf.
# warning and message = FALSE implies ugly messages and warnings are removed from your pdf.
# These should be picked up when you execute the command chunks (code sections below) in your rmd, not printed in your paper!
# Lets load in example data, and see how this can be stored and later called from your 'data' folder.
if(!require("tidyverse")) install.packages("tidyverse")
library(gt)
library(tidyverse)
library(huxtable)
library(kableExtra)
list.literature <- readxl::read_xlsx("data/Literature Summary Table.xlsx")
# Notice that as you are working in a .Rproj file (I am assuming you are) - the relative paths of your directories start at your specified root.
# This means that when working in a .Rproj file, you never need to use getwd() - it is assumed as your base root automatically.
library(xtable)
data <- list.literature %>% tibble::as_tibble()
table <- xtable(data, caption = "previous studies \\label{tab1}")
print.xtable(table,
tabular.environment = "longtable",
floating = TRUE,
table.placement = 'H',
# scalebox = 0.3,
comment = FALSE,
caption.placement = 'bottom'
)
data = list.literature %>% tibble::as_tibble()
addtorow          <- list()
addtorow$pos      <- list()
addtorow$pos[[1]] <- c(0)
addtorow$command  <- c(paste("\\hline \n",
"\\endhead \n",
"\\hline \n",
"{\\footnotesize Continued on next page} \n",
"\\endfoot \n",
"\\endlastfoot \n",sep=""))
table <- xtable(data, caption = "Long Table Example")
print.xtable(table,
tabular.environment = "longtable",
floating = FALSE, # Leave this as is.
table.placement = 'H', # Leave this as is.
booktabs = T, # Aesthetics
include.rownames = FALSE,  # Typically you don't want this in a table.
add.to.row = addtorow, # For adding the Continued on next page part...
comment = FALSE,
caption.placement = 'top',  # Where do you want the caption?
size="\\fontsize{12pt}{13pt}\\selectfont"  # Size of text in table..
)
data = list.literature %>% tibble::as_tibble()
addtorow          <- list()
addtorow$pos      <- list()
addtorow$pos[[1]] <- c(0)
addtorow$command  <- c(paste("\\hline \n",
"\\endhead \n",
"\\hline \n",
"{\\footnotesize Continued on next page} \n",
"\\endfoot \n",
"\\endlastfoot \n",sep=""))
table <- xtable(data, caption = "Long Table Example")
print.xtable(table,
tabular.environment = "longtable",
floating = FALSE, # Leave this as is.
table.placement = 'H', # Leave this as is.
booktabs = T, # Aesthetics
include.rownames = FALSE,  # Typically you don't want this in a table.
add.to.row = addtorow, # For adding the Continued on next page part...
comment = FALSE,
caption.placement = 'top',  # Where do you want the caption?
size="\\fontsize{12pt}{13pt}\\selectfont"  # Size of text in table..
)
table
data
sa_rate_high_vol
interest <- readxl::read_xlsx("data/Interest Rates.xlsx")
library(tidyverse)
library(tbl2xts)
library(lubridate)
interest <- interest %>%
rename(., "Fed" = "US Federal Funds Effective Rate (continuous series)" , "ECB" = "ECB Main Refinancing Operations Announcement Rate", "SA" = "South Africa Repo Avg Rate")
#  tidy it up first
tidy_interest <- interest %>%
gather(Bank, Rate, -Date) %>%
mutate( Month = format(Date, "%b"), YM = format(Date, "%b %y")) %>%
arrange(Date) %>%
group_by(Bank) %>%
ungroup()
#
quarters <- c("Mar", "Jun", "Sep", "Dec")
rateschanges <- tidy_interest %>%
group_by (YM, Bank) %>%
filter(Date == last(Date)) %>%
filter(Month %in% quarters) %>%
arrange(Date) %>%
group_by(Bank) %>%
mutate(diff = Rate - lag(Rate)) %>%
mutate(Changes = ifelse(diff > 0.00, "Hiking", ifelse(diff< 0.00, "Cutting", "Hold"))) %>%
ungroup()
# extract the dates
source("code/regimeextractor.R")
sa_rate_high_vol <- rateschanges %>%
regime_date_extractor(. , Regime = "Hiking", Bank = "SA") %>% as.Date()
#  now lets get its return, use the same df from the other vol stratification
regime_return <- function (df, filter_vector, ){
regime_return <- function (df, filter_vector ){
df <- df %>%
gather(Index, Price, -Date) %>%
arrange(Date) %>%
mutate(YM = format(Date , "%y %b ")) %>%
group_by(Index) %>%
mutate(Ret = Price / lag(Price)) %>%
# this should be a variable
filter(Date %in% filter_vector) %>%
#  get a vector of all indices
mutate(Year = format(Date, "%y")) %>%
group_by(Year) %>%
mutate(Count = n())
df}
# loadings
pacman::p_load("xts", "tidyverse", "tbl2xts", "PerformanceAnalytics",
"lubridate", "glue")
library(tbl2xts)
library(tidyverse)
library(xts)
source("code/EXCESSRETURN.R")
source("code/monthlyreturns.R")
library(quantmod)
source("code/uncompoundedexcess.R")
source("code/simpleexcessreturn.R")
df <- readxl::read_xlsx("data/MAD .xlsx")
# get all permutatation
A <- df %>% MY_excess_return(.,"FUDP", "TUKXG")
B <- df %>% MY_excess_return(., "M2EFDY", "GDUEEGF")
C <- df %>% MY_excess_return(., "M2EUGDY", "GDDUE15X")
D <- df %>% MY_excess_return(., "M2GBDY", "GDDUUK")
E <- df %>% MY_excess_return(., "M2JPDY", "TJDIVD")
F1 <- df %>% MY_excess_return(., "M2USADVD", "GDDUUS")
G <- df %>% MY_excess_return(., "M2WDHDVD", "GDDUWI")
H <- df %>% MY_excess_return(., "SPDAEET", "SPTR350E")
I <- df %>% MY_excess_return(., "SPDAUDT", "SPXT")
J <- df %>% MY_excess_return(., "SPJXDAJT", "TPXDDVD")
K <- df %>% MY_excess_return(., "SPSADAZT", "JALSH")
L <- df %>% MY_excess_return(., "TJDIVD", "JALSH")
#  cumulative excess returns in a single data frame
compare <- list(A, B, C, D, E, F1, G,H,J, K, L) %>%
reduce(inner_join, by='date') %>% gather(ticker, excess, -date)
plot <- compare %>% ggplot(aes(x = date, y = excess)) +
geom_line() +
labs(x = "Date", y = "Return") +
theme_minimal() +
facet_wrap(~ ticker, scales = "free_y", ncol = 4)+
labs(
title = "Cumulative Excess Returns",
subtitle = "Performance of HY and DGPS portfolios globally",
x = "",
y = "Cum Returns",
caption = "Source: Bloomberg"
)
plot
# Now for standard deviation
df %>% regime_return(., sa_rate_high_vol)
sa_rate_high_vol
rateschanges
rateschanges
rateschanges
tidy_interest %>%
group_by (YM, Bank) %>%
filter(Date == last(Date)) %>%
filter(Month %in% quarters) %>%
arrange(Date) %>%
group_by(Bank) %>%
mutate(diff = Rate - lag(Rate)) %>%
mutate(regime = ifelse(count((diff>0)>4), "Hiking", ifelse(count(diff<0)>4), "Cutting", "Hold"))%>%
ungroup()
tidy_interest %>%
arrange(YM, Date, Bank) %>%
group_by(YM, Bank) %>%
filter(Date == last(Date)) %>%
ungroup() %>%
filter(Month %in% quarters) %>%
arrange(Date) %>%
group_by(Bank) %>%
mutate(diff = Rate - lag(Rate)) %>%
mutate(
regime = case_when(
sum(diff > 0, na.rm = TRUE) > 4 ~ "Hiking",
sum(diff < 0, na.rm = TRUE) > 4 ~ "Cutting",
TRUE ~ "Hold"
)
) %>%
tidy_interest %>%
arrange(YM, Date, Bank) %>%
group_by(YM, Bank) %>%
filter(Date == last(Date)) %>%
ungroup() %>%
filter(Month %in% quarters) %>%
arrange(Date) %>%
group_by(Bank) %>%
mutate(diff = Rate - lag(Rate)) %>%
mutate(
regime = case_when(
sum(diff > 0, na.rm = TRUE) > 4 ~ "Hiking",
sum(diff < 0, na.rm = TRUE) > 4 ~ "Cutting",
TRUE ~ "Hold"
)
) %>%
ungroup()
tidy_interest %>%
group_by (YM, Bank) %>%
filter(Date == last(Date)) %>%
filter(Month %in% quarters) %>%
arrange(Date) %>%
group_by(Bank) %>%
mutate(diff = Rate - lag(Rate)) %>%
mutate(
regime = case_when(
sum(diff > 0, na.rm = TRUE) > 4 ~ "Hiking",
sum(diff < 0, na.rm = TRUE) > 4 ~ "Cutting",
TRUE ~ "Hold"
)
) %>%
ungroup()
tidy_interest %>%
group_by (YM, Bank) %>%
filter(Date == last(Date)) %>%
filter(Month %in% quarters) %>%
arrange(Date) %>%
group_by(Bank) %>%
mutate(diff = Rate - lag(Rate)) %>%
mutate(Year = format(Date, "%Y")) %>%
group_by(Year) %>%
mutate(
regime = case_when(
sum(diff > 0, na.rm = TRUE) > 4 ~ "Hiking",
sum(diff < 0, na.rm = TRUE) > 4 ~ "Cutting",
TRUE ~ "Hold"
)
) %>%
ungroup()
rateschanges <- tidy_interest %>%
group_by (YM, Bank) %>%
filter(Date == last(Date)) %>%
filter(Month %in% quarters) %>%
arrange(Date) %>%
group_by(Bank) %>%
mutate(diff = Rate - lag(Rate)) %>%
mutate(Year = format(Date, "%Y")) %>%
group_by(Year) %>%
mutate(
regime = case_when(
sum(diff > 0, na.rm = TRUE) > 4 ~ "Hiking",
sum(diff < 0, na.rm = TRUE) > 4 ~ "Cutting",
TRUE ~ "Hold"
)
) %>%
ungroup()
rateschanges %>%
regime_date_extractor(. , Regime = "Hiking", Bank = "SA") %>% as.Date()
rateschanges
rateschanges <- tidy_interest %>%
group_by (YM, Bank) %>%
filter(Date == last(Date)) %>%
filter(Month %in% quarters) %>%
arrange(Date) %>%
group_by(Bank) %>%
mutate(diff = Rate - lag(Rate)) %>%
mutate(Year = format(Date, "%Y")) %>%
group_by(Year) %>%
mutate(
Changes = case_when(
sum(diff > 0, na.rm = TRUE) > 4 ~ "Hiking",
sum(diff < 0, na.rm = TRUE) > 4 ~ "Cutting",
TRUE ~ "Hold"
)
) %>%
ungroup()
sa_rate_high_vol <- rateschanges %>%
regime_date_extractor(. , Regime = "Hiking", Bank = "SA") %>% as.Date()
sa_rate_high_vol
sa_rate_high_vol <- rateschanges %>%
regime_date_extractor(. , Regime = "Hiking", Bank = "SA") %>% as.Date() %>% distinct()
sa_rate_high_vol <- rateschanges %>%
regime_date_extractor(. , Regime = "Hiking", Bank = "SA") %>% as.Date() %>% unique()
sa_rate_high_vol
rateschanges %>%
regime_date_extractor(. , Regime = "Cutting", Bank = "SA") %>% as.Date() %>% unique()
rateschanges %>%
regime_date_extractor(. , Regime = "Cutting", Bank = "SA") %>% as.Date()
rateschanges %>%
regime_date_extractor(. , Regime = "Hiking", Bank = "Fed") %>% as.Date()
rateschanges %>%
regime_date_extractor(. , Regime = "Hiking", Bank = "Fed") %>% as.Date() %>% unique()
df %>% regime_return (., sa_rate_high_vol)
sa_rate_high_vol <- rateschanges %>%
regime_date_extractor(. , Regime = "Hiking", Bank = "Fed") %>% as.Date() %>% unique()
regime_return <- function (df, filter_vector ){
df <- df %>%
gather(Index, Price, -Date) %>%
arrange(Date) %>%
mutate(YM = format(Date , "%y %b ")) %>%
group_by(Index) %>%
mutate(Ret = Price / lag(Price)) %>%
# this should be a variable
filter(Date %in% filter_vector) %>%
#  get a vector of all indices
mutate(Year = format(Date, "%y")) %>%
group_by(Year) %>%
mutate(Count = n())
df}
df %>% regime_return (., sa_rate_high_vol)
regime_return <- function (df, filter_vector ){
df <- df %>%
gather(Index, Price, -Date) %>%
arrange(Date) %>%
mutate(YM = format(Date , "%y %b ")) %>%
group_by(Index) %>%
mutate(Ret = Price / lag(Price)) %>%
# this should be a variable
filter(Date %in% filter_vector) %>%
#  get a vector of all indices
mutate(Year = format(Date, "%y")) %>%
group_by(Index) %>%
mutate(Count = n())
df}
df %>% regime_return (., sa_rate_high_vol)
